# 人口增长率统一配置重构

## 问题

之前的代码中，`intrinsicGrowthRate`（内在增长率）在多个文件中被重复定义，而且值还不一样：

- `growthComparison.js`: `0.025` (2.5%)
- `logisticGrowth.js` 第115行: `0.03` (3%)
- `logisticGrowth.js` 第318行: `0.02 * tickScale` (2% per 10 ticks)
- `logisticGrowth.js` 第479行: 动态计算

这导致：
1. **维护困难**：修改增长率需要在多个地方修改
2. **不一致性**：不同函数使用不同的增长率，容易出错
3. **难以调试**：不清楚哪个增长率是真正在用的

## 解决方案

创建了统一的配置文件 `growthConfig.js`，作为**增长率主来源**。

说明：当前代码仍存在少量业务级修正参数保留在 `logisticGrowth.js`（例如 AI 承载力倍率、small nation bonus）。这些不是基础增长率常量，但会影响最终增长结果。

### 新增文件

**`src/logic/population/growthConfig.js`**
- 定义所有增长率常量
- 提供统一的获取函数
- 包含难度系数、修正因子等配置

### 修改的文件

1. **`logisticGrowth.js`**
   - 导入 `growthConfig.js`
   - 移除主要硬编码增长率
   - 使用 `getIntrinsicGrowthRate()` 和 `DIFFICULTY_GROWTH_MULTIPLIERS`
   - 保留 AI 业务修正参数（承载力倍率与小国补正）

2. **`growthComparison.js`**
   - 导入 `growthConfig.js`
   - 使用 `GROWTH_RATES.LEGACY` 替代硬编码的 `0.025`

## 使用方法

### 获取AI增长率
```javascript
import { getIntrinsicGrowthRate } from './growthConfig.js';

const tickScale = ticksSinceLastUpdate / 10;
const growthRate = getIntrinsicGrowthRate('ai', tickScale);
```

### 获取玩家增长率
```javascript
const growthRate = getIntrinsicGrowthRate('player', tickScale);
```

### 获取难度调整后的增长率
```javascript
import { getDifficultyAdjustedGrowthRate, DIFFICULTY_GROWTH_MULTIPLIERS } from './growthConfig.js';

const baseRate = getIntrinsicGrowthRate('ai', tickScale);
const adjustedRate = getDifficultyAdjustedGrowthRate('hard', baseRate);

// 或者直接使用乘数
const multiplier = DIFFICULTY_GROWTH_MULTIPLIERS['hard']; // 1.05
```

## 配置说明

### 基础增长率 (GROWTH_RATES)

| 常量 | 值 | 说明 |
|------|-----|------|
| `AI_BASE` | 0.02 | AI国家基础增长率（2% per 10 ticks） |
| `PLAYER_BASE` | 0.02 | 玩家国家基础增长率（2% per 10 ticks） |
| `LEGACY` | 0.025 | 旧版增长率（用于测试对比） |
| `OLD_LOGISTIC` | 0.03 | 旧版logistic增长率（已弃用） |

### 难度系数 (DIFFICULTY_GROWTH_MULTIPLIERS)

| 难度 | 系数 | 说明 |
|------|------|------|
| `veryEasy` | 0.7 | AI增长率 × 0.7 |
| `easy` | 0.85 | AI增长率 × 0.85 |
| `normal` | 1.0 | AI增长率 × 1.0（标准） |
| `hard` | 1.05 | AI增长率 × 1.05 |
| `veryHard` | 1.1 | AI增长率 × 1.1 |
| `impossible` | 1.2 | AI增长率 × 1.2 |

### 增长修正因子 (GROWTH_MODIFIERS)

| 修正因子 | 值 | 说明 |
|----------|-----|------|
| `WAR_PENALTY` | 0.3 | 战争期间增长率 × 0.3 |
| `STARVATION_PENALTY` | 0.5 | 饥荒期间增长率 × 0.5 |
| `GOLDEN_AGE_BONUS` | 1.5 | 黄金时代增长率 × 1.5 |

## 调整增长速度

如果你觉得当前的增长速度不合适，只需要修改 `growthConfig.js` 中的值：

### 降低AI增长速度
```javascript
export const GROWTH_RATES = {
  AI_BASE: 0.015,  // 从 0.02 改为 0.015 (降低25%)
  // ...
};
```

### 调整难度系数
```javascript
export const DIFFICULTY_GROWTH_MULTIPLIERS = {
  'normal': 0.8,  // 从 1.0 改为 0.8 (降低20%)
  // ...
};
```

## 当前已知例外（不在 `growthConfig.js`）

以下参数当前位于 `src/logic/population/logisticGrowth.js`，会影响最终增长结果：

1. `difficultyCapMap`：AI 承载力难度倍率（影响 `K`）。
2. `smallNationBonus`：小人口 AI 的增长加速系数。
3. `calculatePlayerLogisticGrowth` 中的 `PLAYER_BASE / 10` 与玩家专用 bonus 组合。

这些字段属于“业务层修正”，与 `growthConfig.js` 的“基础增长率配置”并存。

### 增加战争惩罚
```javascript
export const GROWTH_MODIFIERS = {
  WAR_PENALTY: 0.2,  // 从 0.3 改为 0.2 (更严重的惩罚)
  // ...
};
```

## 实际增长率计算

最终的增长率是多个因子的乘积：

```
effectiveGrowthRate = intrinsicGrowthRate 
                    × logisticFactor 
                    × resourceFactor 
                    × overcapacityPenalty
                    × difficultyMultiplier
```

### 示例计算（Normal难度，和平时期）

```javascript
// 基础增长率
const intrinsicGrowthRate = 0.02 * (ticksSinceLastUpdate / 10);
// 假设 ticksSinceLastUpdate = 10
// intrinsicGrowthRate = 0.02 * 1 = 0.02 (2%)

// Logistic因子（假设人口是承载力的50%）
const logisticFactor = 1 - 0.5 = 0.5;

// 资源因子（假设资源充足）
const resourceFactor = 1.0;

// 超载惩罚（未超载）
const overcapacityPenalty = 1.0;

// 难度系数（Normal）
const difficultyMultiplier = 1.0;

// 最终增长率
const effectiveGrowthRate = 0.02 × 0.5 × 1.0 × 1.0 × 1.0 = 0.01 (1%)
```

## 注意事项

1. **不要在其他地方定义增长率**：所有增长率都应该从 `growthConfig.js` 导入
2. **修改配置后需要重启游戏**：配置在游戏启动时加载
3. **保持向后兼容**：`LEGACY` 和 `OLD_LOGISTIC` 保留用于测试和对比
4. **新增增长参数时优先级**：先判断是否属于基础增长率。基础参数进入 `growthConfig.js`，业务修正参数保留在调用链并写明用途。

## 相关文件

- `src/logic/population/growthConfig.js` - 配置文件（新增）
- `src/logic/population/logisticGrowth.js` - 增长计算（已修改）
- `src/logic/population/growthComparison.js` - 增长对比（已修改）
- `src/logic/diplomacy/aiEconomy.js` - AI经济（使用增长函数）
