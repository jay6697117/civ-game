# 性能优化方案（Tick 与 UI 全覆盖）

本文只提供思路与方案，不修改代码。目标是同时解决“后期 Tick 变慢”和“UI 渲染卡顿”两类问题。

## 一、先做定位：把问题拆成“模拟计算”与“渲染绘制”

### 1) Tick 侧（逻辑计算）
建议在主循环关键阶段做轻量统计（每 N tick 聚合一次打印），确认耗时大头。

重点候选模块（后期建筑/资源多时会放大）：
- 建筑遍历与升级分布计算
- 资源价格计算（资源 * 建筑 嵌套遍历）
- 需求/供给、人口与阶层相关计算
- 外交/AI 计算

### 2) UI 侧（渲染绘制）
建议在主界面打开 React Profiler 或轻量埋点（组件 render 次数、时间），找出“频繁重渲染”的组件树。

重点候选模块：
- 面板类：资源、日志、建筑、外交、科技等列表型组件
- 统计面板与图表
- 背景/特效类组件（动效过多或频繁重绘）

## 二、Tick 优化思路（逻辑计算）

### 1) 降低复杂度：避免“资源 * 建筑”全量嵌套
当前价格计算为每种资源都遍历所有建筑，后期会被放大。

方案：
- 预构建“资源 -> 产出该资源的建筑列表”，只遍历相关建筑
- 对建筑升级分布结果做缓存（同一 tick 内复用）
- 当建筑数量或升级结构未变化时，跳过价格相关的重建

### 2) 分阶段/分频率更新
不是所有数据都需要每 tick 更新。

方案：
- 价格、需求、贸易、AI 决策等可以改为每 2~5 tick 更新
- 一次 tick 内按优先级更新：战斗/人口 > 经济细节 > UI 统计
- 在“后期”允许降低 tick 精度（例如加速模式下降频率）

### 3) 状态差量化（dirty flag）
建立“变更标记”，只有数据变了才进入计算。

方案：
- 建筑数变了才重算岗位/产出
- 人口结构变化超过阈值才重新分配/迁移
- 资源库存变化较小则跳过价格微调（或采用平滑公式）

### 4) 结构化缓存
大体量数据结构在每 tick 做深拷贝或散列遍历会放大耗时。

方案：
- 使用只读配置与缓存（例如 buildingEffectiveConfig、升级分布）
- 在 simulation 内部维护可复用的中间结果，不在每 tick 反复构建

### 5) 计算拆分到 Web Worker
已存在 worker 模块，可考虑把纯计算拆进 worker，主线程只负责渲染。

方案：
- 价格计算、人口需求、外交 AI 都可拆出去
- worker 与主线程通过结构化传递最小必需的数据

## 三、UI 优化思路（渲染绘制）

### 1) 降低渲染频率
UI 不需要每 tick 都刷新。

方案：
- UI 层设置“节流更新”，例如每 200~500ms 同步一次逻辑状态
- 关键数字用局部动画/平滑过渡，避免全树重渲染

### 2) 虚拟化/分页
列表型组件是常见卡点。

方案：
- 资源、建筑、日志、事件等列表可用虚拟滚动
- 无需全量同时渲染，按可见区域渲染

### 3) 组件拆分与 memo 化
减少无关组件的重复渲染。

方案：
- Panel 内部拆成小组件，并用 memo + stable props
- 避免在渲染中创建新对象/新函数导致 memo 失效

### 4) 动效与背景的降级
后期数据量大时，动效会明显放大卡顿。

方案：
- 可自动降级动画（低性能设备/后期）
- 对背景、粒子、特效启用节流或静态模式

## 四、建议执行顺序（成本最低 -> 收益最大）

1. 简单性能打点（Tick 分段耗时 + UI render 次数）
2. UI 侧节流与 memo 化（低风险）
3. 价格计算的“资源 -> 建筑列表”预索引
4. 关键阶段的分频率更新（价格、AI、贸易）
5. Web Worker 拆分（中等成本，高收益）

## 五、可落地的“后期策略”

当建筑数量/资源数量超过阈值时自动启用：
- Tick 分频率模式（例如价格/AI 改为每 3 tick 更新）
- UI 每 250ms 刷新一次
- 背景/动效降级
- 日志、统计图改为增量更新

## 六、按模块落地清单（Tick 侧）

### 1) 主循环与调度（simulation）
文件：`src/logic/simulation.js`
- 将“价格/贸易/AI/日志”分频率更新（如每 3~5 tick 更新一次）
- 以“建筑数变更/升级变更/资源库存变更”作为触发条件，做计算跳过
- 避免在同一 tick 内重复构建：升级分布、owner 分组、资源索引等
- 对大对象（supply/demand/price/wealth）使用差量更新或局部复制，减少全量重建

### 2) 建筑系统
文件：`src/config/buildings.js`, `src/logic/buildings/effects.js`, `src/logic/simulation.js`
- 预构建“资源 -> 产出建筑列表”索引，避免资源 * 建筑全量嵌套
- 统一缓存升级分布（levelCounts / fullLevelCounts）供多个阶段复用
- 对“未变化建筑”跳过重算（建筑数量/升级状态未变时不计算产出/岗位）

### 3) 资源价格与市场
文件：`src/logic/simulation.js`, `src/logic/economy/prices.js`
- 价格计算拆分为“库存驱动价格”和“生产者成本”两段，后者可低频更新
- 当需求、库存、产出变化低于阈值时，直接使用平滑价格
- 资源级别的缓存：对每个资源保存上一轮计算结果与输入摘要

### 4) 人口与岗位
文件：`src/logic/population/jobs.js`, `src/logic/population/needs.js`, `src/logic/population/growth.js`, `src/logic/simulation.js`
- 岗位分配只在“岗位/人口变化超过阈值”时触发
- 需求与消费计算按阶层跳过：当阶层人口为 0 或资源未解锁直接返回
- 需求模块加“资源可产出过滤”缓存，避免每 tick 重复判断

### 5) 外交与 AI
文件：`src/logic/diplomacy/aiDiplomacy.js`, `src/logic/diplomacy/aiWar.js`, `src/logic/diplomacy/aiEconomy.js`
- AI 决策低频更新（每 N tick），并在国力/关系大幅变化时强制刷新
- 将敌对国家列表、战时状态、关键指标做缓存，减少重复扫描

### 6) 官方与内政系统
文件：`src/logic/officials/cabinetSynergy.js`, `src/components/panels/officials/FreeMarketPanel.jsx`
- 政策计算拆出纯函数结果缓存（依赖变更时才重算）
- UI 面板展示数据只在政策/市场参数变化时刷新

### 7) 日志与事件
文件：`src/components/panels/LogPanel.jsx`, `src/config/events/*`
- 日志采用“批量追加 + 上限裁剪”，避免频繁渲染大列表
- 事件触发条件做低频扫描或分段检查

## 七、按模块落地清单（UI 侧）

### 1) 顶部与资源面板
文件：`src/components/layout/StatusBar.jsx`, `src/components/panels/ResourcePanel.jsx`
- 节流更新（200~500ms 合并状态更新）
- 数值类拆分成细粒度子组件 + memo

### 2) 列表与卡片面板
文件：`src/components/tabs/*`, `src/components/panels/*`
- 建筑/科技/外交/军队等长列表使用虚拟滚动
- 列表项组件 memo，并避免传入新对象/新函数

### 3) 图表与动态组件
文件：`src/components/common/SimpleLineChart.jsx`, `src/components/common/DynamicEffects.jsx`
- 图表改为“增量追加数据点”，降低全量重绘
- 动效组件在后期自动降级（减少粒子/帧率）

### 4) Modal 与详情面板
文件：`src/components/modals/*`, `src/components/panels/*Detail*`
- 仅在打开时订阅数据，关闭时解绑
- 避免全局状态变化引起 modal 重新渲染

## 八、落地优先级（建议）
1. 价格计算与资源索引优化（最容易出现 O(R*B) 放大）
2. UI 节流 + 列表虚拟化（收益明显，风险低）
3. 分频率更新（AI/贸易/价格）
4. Worker 拆分（中等成本，高收益）

## 九、执行表（优先级 + 预估工时 + 风险等级）

说明：
- 工时为粗略估算（S: 0.5~1 天，M: 2~3 天，L: 4~7 天，XL: 2 周+）
- 风险等级表示对玩法一致性/数值稳定性的影响风险

| 模块 | 具体事项 | 优先级 | 预估工时 | 风险等级 |
| --- | --- | --- | --- | --- |
| 资源价格与市场 | 资源 -> 产出建筑列表索引，替换资源 * 建筑全量遍历 | P0 | M | 低 |
| 资源价格与市场 | 价格计算拆分为低频成本更新 + 高频库存更新 | P0 | M | 中 |
| 主循环与调度 | 价格/贸易/AI 分频率更新 | P0 | S | 中 |
| UI 列表 | 资源/建筑/日志/科技等列表虚拟滚动 | P0 | M | 低 |
| UI 节流 | 全局 UI 状态更新节流（200~500ms） | P0 | S | 低 |
| 建筑系统 | 升级分布缓存复用（levelCounts / fullLevelCounts） | P1 | S | 低 |
| 建筑系统 | 建筑未变化时跳过岗位/产出重算 | P1 | M | 中 |
| 人口与岗位 | 岗位分配按阈值触发 | P1 | M | 中 |
| 人口与岗位 | 需求与消费跳过逻辑 + 资源可产出缓存 | P1 | S | 低 |
| 外交与 AI | AI 决策低频更新 + 关键事件触发刷新 | P1 | M | 中 |
| 日志与事件 | 日志批量追加 + 上限裁剪 | P1 | S | 低 |
| UI 动效 | 后期自动降级动效/背景 | P2 | S | 低 |
| Worker 拆分 | 价格计算迁移到 worker | P2 | L | 中 |
| Worker 拆分 | 人口需求/外交 AI 迁移到 worker | P2 | L | 高 |
