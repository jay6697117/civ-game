# 人口增长系统重构 - 从指数增长到逻辑斯蒂模型

## 🧭 当前状态快照（2026-02-28）

1. AI 人口增长：已接入 `calculateAILogisticGrowth` 并在线运行。
2. 玩家人口增长：主循环仍使用 `simulation.js` 中生育/容量段逻辑。
3. `calculatePlayerLogisticGrowth`：函数已存在，但尚未接入玩家主循环。

## 🎯 问题

原有的人口增长系统存在严重问题：

### AI国家
```javascript
// 旧代码：纯指数增长
population *= (1 + 0.025)  // 每10 ticks增长2.5%
```

**问题**：
- ❌ 无限制的指数增长
- ❌ 完全不考虑资源限制
- ❌ 地狱难度下16天就能达到1亿人口
- ❌ 不考虑粮食、土地、住房等约束

### 玩家国家
虽然有`maxPop`限制，但在达到上限前也是指数增长，同样不考虑资源约束。

## ✅ 解决方案

实现了基于**逻辑斯蒂增长模型（Logistic Growth Model）**的科学人口增长系统。

### 核心公式
```
dP/dt = r × P × (1 - P/K) × ResourceFactor

其中：
- P: 当前人口
- K: 环境承载力（由粮食、土地、住房决定）
- r: 内在增长率
- ResourceFactor: 资源约束因子（粮食、财富、民意、战争）
```

### 关键特性

1. **S型增长曲线**
   - 初期：缓慢起步
   - 中期：快速增长
   - 后期：接近承载力时自动减速
   - 超载：负增长

2. **资源承载力**
   ```javascript
   K = min(
       foodCapacity,    // 粮食能养活多少人
       landCapacity,    // 土地能容纳多少人
       housingCapacity  // 住房能容纳多少人
   ) × techMultiplier
   ```

3. **资源约束因子**
   - 粮食充足（≥150%）：1.3倍增长
   - 粮食正常（100%）：1.0倍增长
   - 粮食短缺（70%）：0.5倍增长
   - 严重短缺（<70%）：负增长

## 📁 新增文件

### 1. 核心模型
**文件**: `src/logic/population/logisticGrowth.js`

**导出函数**：
- `calculateCarryingCapacity()` - 计算环境承载力
- `calculateResourceFactor()` - 计算资源约束因子
- `calculateLogisticGrowth()` - 核心逻辑斯蒂增长计算
- `calculateAILogisticGrowth()` - AI国家专用
- `calculatePlayerLogisticGrowth()` - 玩家国家专用

### 2. 对比测试
**文件**: `src/logic/population/growthComparison.js`

**功能**：
- 对比旧模型（指数）vs 新模型（逻辑斯蒂）
- 演示不同资源场景下的增长差异
- 可视化增长曲线

**运行测试**：
```javascript
import { demonstrateScenarios } from './logic/population/growthComparison';
demonstrateScenarios();
```

### 3. 详细文档
**文件**: `docs/逻辑斯蒂人口增长模型.md`

包含：
- 科学原理详解
- 公式推导
- 参数说明
- 实际效果对比
- 使用示例

## 🔧 修改的文件

### 1. AI经济模块
**文件**: `src/logic/diplomacy/aiEconomy.js`

**修改**：
- 导入逻辑斯蒂增长模型
- 修改`processAIIndependentGrowth()`函数
- 使用`calculateAILogisticGrowth()`替代指数增长

### 2. 主模拟循环
**文件**: `src/logic/simulation.js`

**修改**：
- 传递`epoch`和`playerPopulation`参数给AI增长函数

## 📊 效果对比

### 场景：地狱难度，低粮食产量

| 天数 | 旧模型（指数） | 新模型（逻辑斯蒂） | 承载力 |
|-----|--------------|-----------------|--------|
| 0 | 16 | 16 | 40 |
| 20 | 26 | 24 | 40 |
| 40 | 43 | 32 | 40 |
| 60 | 70 | 37 | 40 |
| 80 | 115 | 39 | 40 |
| 100 | 189 | **40** | 40 |

**结果**：
- 旧模型：100天达到189人口（超载4.7倍！）
- 新模型：100天稳定在40人口（符合承载力）

### 场景：地狱难度，高粮食产量

| 天数 | 旧模型 | 新模型 | 承载力 |
|-----|--------|--------|--------|
| 0 | 16 | 16 | 400 |
| 50 | 54 | 56 | 400 |
| 100 | 189 | 175 | 400 |
| 150 | 658 | 310 | 400 |
| 200 | 2,291 | 380 | 400 |

**结果**：
- 旧模型：200天达到2291人口（失控）
- 新模型：200天接近400人口（合理）

## 🎮 游戏影响

### 对玩家
1. **资源管理更重要**：必须平衡粮食、土地、住房
2. **策略性提升**：不能只建军事建筑，要考虑人口承载力
3. **更加现实**：人口增长符合真实世界规律

### 对AI
1. **增长更合理**：不会在短时间内达到不现实的人口
2. **难度更平衡**：高难度下AI有优势，但不会离谱
3. **资源约束**：AI也受粮食、土地限制

## 🚀 使用方法

### AI国家（已自动集成 - 完整版）

**重要更新**：AI国家使用**完整版逻辑斯蒂模型**，因为AI有完整的资源库存系统！

```javascript
// 在 aiEconomy.js 中自动调用
const newPopulation = calculateAILogisticGrowth({
    nation,  // 包含 inventory: { food, wood, stone, ... }
    epoch,
    difficulty,
    playerPopulation,
    ticksSinceLastUpdate
});
```

**完整版特点**：
- ✅ 基于真实的 `inventory.food`（粮食库存）
- ✅ 基于 `resourceBias.food`（粮食偏好）计算粮食产量
- ✅ 基于 `ownBasePopulation` 和 `epoch` 估算土地面积
- ✅ 基于 `developmentRate` 计算住房容量
- ✅ 基于 `epoch` 计算科技加成
- ✅ 完整的S型曲线，有真实的资源约束
- ✅ 粮食短缺会减缓增长，粮食盈余会加速增长

### 玩家国家（待集成）
```javascript
// 在 simulation.js 中替换现有的人口增长逻辑
import { calculatePlayerLogisticGrowth } from './logic/population/logisticGrowth';

const result = calculatePlayerLogisticGrowth({
    currentPopulation: state.population,
    resources: state.resources,
    buildings: state.buildings,
    epoch: state.epoch,
    bonuses: state.bonuses,
    approval: state.approval,
    isAtWar: state.isAtWar,
    difficulty: state.difficulty
});

state.population = result.newPopulation;
```

## 📈 下一步

### 待完成
- [ ] 将逻辑斯蒂模型应用到玩家国家（替换 `simulation.js` 的现有增长段）
- [ ] 在UI中显示承载力信息
- [ ] 添加承载力预警系统
- [ ] 优化AI的资源估算逻辑

### 验收条件（玩家迁移完成的判断标准）

1. 玩家主循环人口更新入口改为 `calculatePlayerLogisticGrowth`。
2. 粮食短缺、失业率、政策加成与人口变化的联动通过回归测试。
3. 关键难度（normal/hard/veryHard）下 100~200 天人口曲线无异常突变。
4. 与 AI 增长链路共存时，不引入外交/经济联动回归。

### 未来改进
- [ ] 动态承载力（随科技提升）
- [ ] 区域差异（不同地形的承载力）
- [ ] 疾病系统（高密度的风险）
- [ ] 移民系统（人口流动）
- [ ] 年龄结构（人口金字塔）

## 🧪 测试

运行对比测试：
```bash
node src/logic/population/growthComparison.js
```

或在游戏中：
```javascript
import { demonstrateScenarios } from './logic/population/growthComparison';
demonstrateScenarios();
```

## 📚 参考资料

- [逻辑斯蒂人口增长模型详细文档](./docs/逻辑斯蒂人口增长模型.md)
- [Logistic Function - Wikipedia](https://en.wikipedia.org/wiki/Logistic_function)
- [Carrying Capacity - Wikipedia](https://en.wikipedia.org/wiki/Carrying_capacity)

---

**版本**: 1.0.0  
**日期**: 2026-01-29  
**状态**: ✅ AI国家已完成，⏳ 玩家国家待集成  
**Last verified against commit**: `9015497` (2026-02-28)
