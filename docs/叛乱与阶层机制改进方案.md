# 叛乱与阶层机制改进方案 V3 (Rebellion Project V3)

V3 版本基于对代码库 (`decrees.js`, `StrataPanel.jsx`) 的深入分析，补充了具体的游戏数值、现成资源引用和详细的 UI 整合方案。

## 0. 现有稳定性机制分析与重构 (Stability Mechanics Analysis)

**现状 (Current Mechanism)**:
目前的稳定性是一个**派生值 (Derived Value)**。每一个 Tick，系统都会根据当前的“加权阶层支持度 + Buff/Debuff 修正值”完全重新计算稳定性。
公式：`Stability = (Weighted Approval) + (Active Modifiers)`

**问题 (The Problem)**:
- **毫无惯性 (Zero Inertia)**: 稳定性没有“记忆”。如果支持度因为某个临时原因（如市场短暂缺货）瞬间暴跌，稳定性也会瞬间暴跌；一旦恢复，稳定性也瞬间跳回。这种“瞬间变化”让玩家感觉不到危机的沉重感。
- **事件/Buff 无感 (Events Feel Weak)**: 很多事件如果设计为“一次性扣除 10 点稳定性”，在当前机制下完全无效。因为它只改变当前这一帧的数值，下一帧就被重新计算覆盖了。除非事件施加一个持续 30 天的 Debuff，否则玩家根本感觉不到惩罚。这正是“存在感薄弱”的根源。

**解决方案：稳定性惯性 (Stability Inertia)**
我们将稳定性从“派生值”改为“具有惯性的独立状态值”。

**新公式**:
`NextStability = CurrentStability + (TargetStability - CurrentStability) * 0.05`

- **TargetStability**: 由支持度计算出的目标值（即当前的旧稳定性）。
- **0.05 (Inertia Factor)**: 惯性系数（约 5%）。意味着稳定性每天只会向目标值移动一小步。
- **效果**:
    - **危机感**: 当支持度崩盘时，稳定性会缓慢但不可阻挡地滑落，给玩家反应时间，但同时也意味着一旦跌下去，想要拉回来也需要漫长的过程（不仅要修好支持度，还要等稳定性慢慢爬升）。
    - **事件冲击**: 我们终于可以实现“地震：稳定性直接 -10”这样的瞬间冲击事件。这 -10 会真实地扣除在当前稳定性上，然后系统会花费数周时间慢慢平复这个冲击（趋向目标值），模拟了国家受创后的恢复期。

## 1. 核心理念：组织度详解 (Organization Mechanic)

我们摒弃了"随机叛乱"，引入了**组织度 (Organization)** 作为衡量阶层反叛能力的核心指标。

### A. 定义与区别
*   **支持度 (Approval)**: 代表**"意愿"** (Will)。他们有多恨你？
*   **组织度 (Organization)**: 代表**"能力"** (Capability)。他们不仅恨你，还建立了秘密结社、囤积了武器、选出了领袖。
*   **区别**: 一群愤怒但分散的农民 (低组织度) 只是暴民；一群训练有素且愤怒的私兵 (高组织度) 则是革命军。

### B. 增长与衰减逻辑 (The Algorithm)
组织度的变化是**确定性**的，遵循以下数学逻辑：

`每日增量 = (基础怒气) × (阶层影响力) × (国家稳定性阻尼)`

1.  **动力源 (Fuel)**: 当 **支持度 < 45** 时，组织度开始增长。支持度越低，增长越快。
    *   *例: 30 支持度 -> +0.5/天; 0 支持度 -> +2.0/天。*
2.  **倍增器 (Multiplier)**: **阶层影响力 (Influence)** 是关键系数。
    *   *权贵阶层 (Landowner/Capitalist)* 拥有资源和人脉，他们的组织速度是普通阶层的 **1.5倍 - 2倍**。
    *   *底层阶层 (Peasant)* 虽然人数众多，但组织起来较慢，除非有外部煽动。
3.  **阻尼器 (Dampener)**: **稳定性 (Stability)** 直接抑制组织度。
    *   稳定度 100% -> 抑制 80% 的组织度增长（很难造反）。
    *   稳定度 0% -> 无抑制，组织度满速飙升。

### C. 衰减 (Decay)
*   当 **支持度 > 50** 时，组织度开始自然衰减。
*   当 **支持度 > 80 (忠诚)** 时，衰减速度翻倍。
*   这意味着：**一旦危机形成，仅仅把支持度拉回及格线 (50) 是不够的**，你必须让他们感到满意 (>80) 才能快速瓦解叛乱组织，或者使用“镇压”手段强制清零。

### D. 阶段阈值 (Stages)
*   **0-29% (不满 Grumbling)**: 隐蔽阶段，轻微经济惩罚。
*   **30-59% (动员 Mobilizing)**: 出现明显经济破坏（罢工/抗税），生成**诉求 (Demands)**。
*   **60-89% (激进 Radicalizing)**: 严重破坏，无法通过温和手段安抚。
*   **90-100% (起义 Uprising)**: 图标闪烁，内战一触即发。此时只能**军事镇压**，无法谈判。

### D. 与现有事件链的整合 (Integration)
我们完全保留并利用游戏中现有的 `rebellionEvents.js` 事件链，将其触发条件从 RNG 改为确定性的**组织度阈值**：

| 组织度 | 对应旧阶段 (Phase) | 触发事件 (Legacy) | 调整后的逻辑 |
| :--- | :--- | :--- | :--- |
| **30%** | `BREWING` (酝酿) | `createBrewingEvent` | 此时出现“流言蜚语”事件。选项：<br>• **安抚**: 少量降低组织度。<br>• **调查**: 揭示具体的不满来源。 |
| **60%** | `PLOTTING` (密谋) | `createPlottingEvent` | 此时出现“发现密谋”事件。选项：<br>• **谈判**: 转化为具体诉求任务。<br>• **逮捕**: 相当于免费的一次“镇压”(Crackdown)。 |
| **100%** | `ACTIVE` (叛乱) | `createActiveRebellionEvent` | 爆发内战。生成 `RebelNation`，军队倒戈。 |

*注：原有的随机概率 (`BREWING_CHANCE` 等) 将被废除，完全由组织度驱动。*

## 2. 机制详解：动态诉求 (Dynamic Demands)

诉求系统将直接挂钩游戏内的具体变量。当阶层进入 **II. 组织阶段 (50-89%)** 时，会根据不满的主要来源生成诉求。

### 诉求类型表

| 诉求代码 | 触发原因分析 | 具体要求 (Exaction) | 失败后果 |
| :--- | :--- | :--- | :--- |
| **TAX_RELIEF**<br>(减税) | 未满足需求主要是因为买不起 (unaffordable) 且税率 > 150% | **任务**: 将该阶层的所有税率（人头税/资源税）降至 100% 或更低，保持 10 天。 | 组织度 +15%，该阶层税收贡献暂时归零（抗税）。 |
| **SUBSIDY**<br>(补贴) | 即使零税率也买不起关键生存物资 (food/cloth) | **行动**: 直接向该阶层发放一笔“生存补贴” (每人 5 银币)。<br>*注：通过 `activeDebuffs` 实现临时收入加成* | 组织度 +10%，不满飙升。 |
| **RESOURCE**<br>(物资) | 市场缺货 (outOfStock) 导致无法购买 | **任务**: 市场中目标资源库存 > 该阶层30天消耗量 (`Pop * Need * 30`)。 | 组织度 +20%，触发“抢劫仓库”事件（扣除库存）。 |
| **POLITICAL**<br>(政治) | 满意度低但相对富裕，影响力高 | **行动**: 颁布有利政令。例如：<br>• 工人 -> `factory_act` (工厂法)<br>• 贵族 -> `magna_carta` (大宪章)<br>• 军队 -> `standing_army` (常备军制) | 组织度 +25%，造成严重政治动荡（稳定度 -15%，文化值减半）。 |

## 3. 机制详解：深度对抗 (Strategic Actions)

在阶层面板中新增“应对”菜单，提供以下策略选择：

| 行动 | 消耗 | 效果 | 冷却 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **镇压 (Crackdown)** | 300 银币<br>**军心动摇**: 军人/骑士支持度 -15 | • **组织度**: -30% (强制打断)<br>• **满意度**: -20 (更加仇恨)<br>• **稳定度**: -5%<br>• **疲惫**: 获得 "镇压疲惫" Debuff (军事力量 -20%，持续30天) | 30天 | 叛乱即将爆发 (90%+) 时的紧急刹车，用时间换空间。 |
| **分化 (Divide)** | 200 文化点数<br>500 银币 | • **目标阶层**: 组织度 -40%<br>• **对立阶层**: 组织度 +20% (被激怒)<br>*例：此行动会挑起“地主 vs 佃农”或“资本家 vs 工人”的矛盾* | 60天 | 多个阶层同时不满时，以此瓦解联盟。 |
| **收买 (Bribe)** | 银币 = 人口 * 10 | • **满意度**: +15 (持续 30 天)<br>• **组织度**: 停止增长 10 天 | 15天 | 只要钱能解决的问题，就不是问题。但成本会随次数递增。 |
| **承诺 (Promise)** | 无直接消耗<br>信誉风险 | • **组织度**: 立即 -20%<br>• **生成任务**: 限时完成特定目标（如“30天内将面包价格降至2.0以下”）。<br>• **失败惩罚**: 组织度直接 +50% 并进入爆发状态。 | 90天 | 实在没钱没兵时的最后手段。 |

## 4. UI 实施方案 (UI Implementation)

基于 `StrataPanel.jsx` 的现有结构进行扩展。

### A. 面板布局变更
在现有阶层卡片（Desktop）或弹窗（Mobile）中增加 `ActiveRebellionStatus` 区域。

1.  **进度条整合**:
    *   在原有的“满意度”进度条下方，增加一条**“组织度” (Organization) 进度条**。
    *   **颜色**: 灰色 (0-29%) -> 黄色 (30-49%) -> 橙色 (50-89%) -> 闪烁红 (90-100%)。
    *   **动画**: 当组织度由于不满正在增长时，进度条有脉动效果；右侧显示 `(+1.5/天)` 的增长率。

2.  **状态图标**:
    *   在阶层名称旁增加状态 Icon：
        *   `Coffee` (平静)
        *   `Eye` (酝酿 - 此时可以查看诉求)
        *   `Flame` (起义 - 此时只能镇压)

3.  **互动菜单**:
    *   点击阶层卡片展开的详情页中，新增 **"Action" (行动)** 标签页。
    *   列出上述 "镇压"、"分化" 等按钮，按钮上直接显示消耗和预测结果。

### B. 悬浮提示 (Tooltip)
鼠标悬停在组织度进度条上时显示：
> **工人阶级组织度: 65% (密谋中)**
>
> 增长原因:
> *   严重不满 (+3.0/天)
> *   低稳定度加成 (+0.5/天)
> *   工会领袖煽动 (+1.0/天)
>
> *如果不采取措施，预计 12 天后爆发叛乱。*

## 5. 经济后果：组织度的代价 (The Cost of Unrest)

仅仅“等待叛乱条读满”是无聊的。高组织度（骚乱）本身就应该对国家经济造成实质性伤害。我们将组织度定义为**“社会阻力系数”**。

### A. 阶层专属的被动惩罚 (Passive Penalties)
当某阶层的组织度超过 **30% (不满)** 和 **60% (动荡)** 阈值时，会触发以下持续性 Debuff：

| 阶层 | 30% 组织度 (怠工/抗议) | 60% 组织度 (罢工/破坏) | 设计逻辑 |
| :--- | :--- | :--- | :--- |
| **农民 (Peasant)** | **减产**: 农场/种植园产出 -15%。 | **抗粮**: 粮食税收归零。<br>**囤积**: 市场粮食供应量 -30%（粮价暴涨）。 | 威胁国家的“胃”。 |
| **工人 (Worker)** | **怠工**: 工业建筑产出 -15%。 | **大罢工**: 工业建筑产出 -50%。<br>**破坏**: 每日直接扣除少量 `tools` 和 `stock` (代表损耗)。 | 威胁国家的“手”。 |
| **商人 (Merchant)** | **避税**: 商业税收入 -15%。 | **关门**: 市场/港口效率 -50%。<br>**资本外逃**: 每日流失 0.5% 国库银币。 | 威胁国家的“血”。 |
| **地主 (Landowner)** | **私产**: 土地产出 -20% (隐瞒产量)。 | **地方割据**: 农业税收归零。<br>**阻挠**: 建筑建造成本 +20%。 | 威胁国家的“基石”。 |
| **资本家 (Capitalist)** | **投资收缩**: 商业税收入 -20%。 | **股灾**: 商业/工业税收归零。<br>**撤资**: 每日流失 1% 国库银币。 | 威胁国家的“未来”。 |
| **军队 (Soldier)** | **纪律涣散**: 军事力量 -10%。 | **兵变风险**: 军事力量 -50%。<br>**抗命**: 无法执行任何手动军事行动。 | 威胁国家的“剑”。 |
| **教士/学者** | **传播受阻**: 文化/科研产出 -15%。 | **煽动**: 每日降低全局稳定度 -0.5。<br>**异端**: 随机废除一项已生效的政令 (如果有)。 | 威胁国家的“魂”。 |

### B. 经济连锁反应 (Chain Reaction)
这些惩罚不是孤立的，它们会通过**产业链**传导：
*   **例子**: *农民抗粮 (粮价涨) -> 工人生活成本飙升 (不满涨) -> 工人大罢工 (工具停产) -> 矿山效率下降*。
*   玩家必须在经济崩溃前做出抉择：是向单一阶层妥协，还是使用强硬手段（可能引爆全面内战）。

---

## 6. 阶层对立逻辑深层化 (Deepened Conflict Logic)

"分化 (Divide)" 行动依赖于预设的阶层矛盾关系。当对某阶层使用分化时，会自动波及其对立阶层。

**核心对立组 (Rival Pairs):**

| 矛盾类型 | 激进方 (Target) | 保守方 (Rival) | 矛盾根源 |
| :--- | :--- | :--- | :--- |
| **土地矛盾** | **佃农 (Serf)** / **农民 (Peasant)** | **地主 (Landowner)** | 地租、土地兼并、人身依附。 |
| **劳资矛盾** | **工人 (Worker)** / **矿工 (Miner)** | **资本家 (Capitalist)** | 工资、工时、劳动条件。 |
| **赋税矛盾** | **商人 (Merchant)** / **工匠 (Artisan)** | **官员 (Official)** | 关税、行会限制、贪腐。 |
| **新旧矛盾** | **教士 (Cleric)** | **学者 (Scribe)** / **工程师 (Engineer)** | 传统信仰 vs 科学理性。 |
| **军政矛盾** | **军人 (Soldier)** / **骑士 (Knight)** | **官员 (Official)** | 军费预算、文官治军。 |

**分化计算逻辑:**
1.  **选择目标**: 玩家选择安抚/打压 "激进方" (如工人)。
2.  **寻找对手**: 系统查找对应的 "保守方" (如资本家)。
3.  **效果结算**:
    *   **工人 (Target)**: 组织度 **大幅下降 (-40%)**。描述: *"政府利用资本家的力量破坏了工会。"*
    *   **资本家 (Rival)**: 组织度 **小幅上升 (+20%)**，满意度 **小幅下降 (-10)**。描述: *"资本家虽然赢了，但对政府插手感到警惕。"*

*如果没有明确对立阶层（如失业者），则默认对立面为“官员”或“所有富裕阶层”。*
