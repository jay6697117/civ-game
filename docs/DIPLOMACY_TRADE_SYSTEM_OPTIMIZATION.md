## 外交与贸易系统优化方案（Diplomacy & Trade 2.0）

> 目的：将当前系统从“固定贸易路线/弱外交加减关系”升级为“派驻商人驱动的自适应贸易 + 以协议为核心的外交网络 + 联盟/附庸等长期结构玩法”，解决国内供需失衡并显著增强外交可玩性。

---

### 1. 背景与问题拆解

#### 1.1 当前痛点（从玩家体验角度）

- **贸易层面**
  - 现有系统缺少“缺啥买啥”的主动纠偏能力，导致国内生产后无法有效分流/补足。
  - 玩家无法通过“战略性贸易投入（商人、人力、港口能力）”去塑造宏观结果，贸易更像一次性按钮或静态路线。
  - 贸易行为对双方市场（价格/库存）影响不足或缺失，导致系统无法形成自稳定闭环。

- **外交层面**
  - 外交缺少“协议化”的长期结构：学术交流、开放市场、最惠国、共同防御等应当以契约形式存在。
  - 缺少“集团化”玩法：多同盟形成北约式军事联盟；缺少附庸体系与宗主-附庸的权利义务。

#### 1.2 设计目标（可验收）

- **贸易**
  - 国内严重短缺时：贸易能自动优先进口（即便低利润）。
  - 国内严重过剩时：贸易能自动倾向出口/倾销，库存回归目标区间。
  - 贸易会显著改变双方价格/库存，并反过来影响下一回合贸易决策（闭环）。

- **外交**
  - 关键外交行为以**协议（Treaty）**承载：有期限、有义务、有违约代价。
  - 存在明确的学术交流、贸易条约、附庸体系、军事联盟（北约式）玩法闭环。

---

### 2. 贸易系统 Trade 2.0（核心：派驻商人 + 自动撮合 + 市场反馈）

#### 2.1 取消“自由贸易路线”，改为“对国家派驻商人”

**玩家操作**：对每个外国设置派驻商人数量，而非手动配置每条贸易路线。

- `merchantAssignments[nationId] = count`
- 可选：为该国设置贸易姿态
  - `policy`: `balanced | import_priority | export_priority | embargo | smuggling`

**系统行为**：每回合对每个派驻国进行自动撮合：
- 选择最优的商品组合（进口/出口）
- 受限于商人数、贸易容量、外交条约、关税、运输距离/风险
- 结算并反馈到双方市场价格与库存

**为什么这样更好**
- 玩家用“商人配额”表达战略重心（把贸易能力投到哪里）。
- 系统自动处理微观商品选择，玩家聚焦宏观战略。

---

#### 2.2 “缺啥买啥”的交易决策（优先保供，其次利润）

将交易决策拆成两层：

- **层 A：供需纠偏层（强偏好）**
  - 对国内短缺程度高的关键品类：提高进口权重，允许低利润甚至微亏。
  - 对国内过剩严重的品类：提高出口权重，允许“倾销式”出口来释放库存。

- **层 B：收益优化层（软优化）**
  - 在满足层 A 方向的前提下，选择利润/效率/风险综合最优的组合。

##### 2.2.1 数据准备：库存、目标库存、价格

- `stock[resource]`: 当前库存
- `targetStock[resource]`: 目标库存（可由人口、产业规模、军备需求推导）
- `price[resource]`: 当前市场价

定义标准化短缺/过剩指标（示意）：

- `shortage = clamp((targetStock - stock) / max(targetStock, 1), 0, 1)`
- `surplus  = clamp((stock - targetStock) / max(targetStock, 1), 0, 1)`

##### 2.2.2 评分模型（示意，可直接落地为函数）

**进口评分** `ImportScore(r)`：

- 国内短缺：`w_shortage * shortageHome(r)`
- 价格优势：`w_price * max(0, (priceHome(r) - priceForeign(r)) / priceHome(r))`
- 对方供给能力：`w_supply * supplyForeign(r)`
- 外交修正：条约/关系/禁运
- 风险修正：战争、海盗、制裁

**出口评分** `ExportScore(r)`：

- 国内过剩：`w_surplus * surplusHome(r)`
- 对方短缺：`w_foreign_shortage * shortageForeign(r)`
- 价格优势：`w_price * max(0, (priceForeign(r) - priceHome(r)) / priceForeign(r))`
- 外交/风险修正同上

> 建议：让 `w_shortage`、`w_surplus` 在“保供模式”时更高；在“赚钱模式”时降低。

---

#### 2.3 市场反馈：贸易必须影响双方市场（价格/库存/预期）

这是解决“供需失衡”的关键闭环。

##### 2.3.1 库存驱动的基础价格

每回合对每个资源进行基础价格更新（示意）：

- `priceBaseNext = priceBase * (1 + k * (targetStock - stock) / max(targetStock, 1))`
- 对价格做上下限与平滑：避免剧烈震荡

##### 2.3.2 贸易冲击（短期价格冲击）

当发生交易量 `tradeQty`：

- **出口（本国卖出）**：本国库存下降 → 本国价上升；对方库存上升 → 对方价下降
- **进口（本国买入）**：本国库存上升 → 本国价下降；对方库存下降 → 对方价上升

好处：
- 大额套利会自行“抹平价差”，避免永远固定高利润。
- 系统更像真实市场：贸易越多，越改变市场环境。

---

#### 2.4 贸易容量：商人并非无限吞吐

让“商人数量”真正成为资源：

- 每个商人每回合有最大运输量：`merchantCapacity`
- 受港口/道路/舰队护航、距离影响
- 可引入“贸易基础设施”升级：
  - 港口等级提升 `merchantCapacity`
  - 商队/货船科技提升单位成本与损耗

**容量约束**：
- `maxTradeVolume(nation) = merchantAssignments[nation] * merchantCapacity * infraModifier * treatyModifier`

---

#### 2.5 贸易权限与强制自由贸易（你的“不给卖就开战”）

将“能否贸易”从关系阈值升级为**制度性权限**：

- **开放市场（Open Market Treaty）**：允许驻商与交易
- **最惠国（MFN Treaty）**：降低关税，提高成交效率
- **关税（Tariff Treaty / Policy）**：增加交易成本（影响最终有效价格）
- **禁运（Embargo）**：禁止交易

**胁迫链条**：

1. 最后通牒（外交行动）：要求对方开放市场 / 解除禁运
2. 拒绝：你获得“宣战借口”（降低宣战声誉惩罚、提高国内支持）
3. 战胜后条款：强制开放市场、赔款、朝贡、通行权、驻军等

---

### 3. 外交系统 Diplomacy 2.0（核心：协议 + 信誉 + 集团结构）

#### 3.1 Treaty（协议）系统：外交的统一承载层

把“外交动作”尽量变成“协议对象”，带来长期收益与长期约束。

##### 3.1.1 Treaty 数据结构建议（概念）

- `id`
- `type`: `open_market | mfn | research_exchange | non_aggression | alliance | vassalage | defensive_pact | tariff_agreement | embargo`
- `parties`: 缔约国列表（2国或多国）
- `startTurn`, `endTurn`（可为永久）
- `terms`: 条款（结构化）
- `maintenance`: 维护成本（银币/资源/影响力）
- `breachRules`: 违约判定
- `breachPenalty`: 违约惩罚（信誉、赔款、制裁、盟内惩罚）

##### 3.1.2 Reputation / Trust（信誉/信任）

- 撕约、背刺、拒绝履约：降低信誉
- 信誉影响：
  - 签约成功率
  - 对方要价（更高维护费/更严格条款）
  - 联盟表决倾向

---

#### 3.2 学术交流（Academic Exchange）

目标：提供稳定、可经营的和平红利，使外交不只是战争前戏。

**协议条款示例**：

- 每回合支付：`scienceFunding`（银币）
- 双方获得：科技点倍率 / 特定学科加成 / 研究速度提升
- 可选互惠条款：你给钱，对方给技术扩散；或对等投入

**事件（可选增强）**：
- 技术泄露（对方获得你更高比例的科技扩散）
- 学者遇袭（战争/制裁导致中止）
- 间谍渗透（外交对抗玩法挂钩）

---

#### 3.3 附庸体系（Suzerain–Vassal）

附庸不是同盟弱化版，而是**层级关系**。

**附庸义务**：
- 进贡（银币/资源）
- 外交从属（限制独立结盟/宣战）
- 战争协从（宗主遭攻击时参战或提供军需）

**宗主义务**：
- 保护（被攻击介入）
- 支援（可选条款：驻军、技术援助、贷款）

**获得方式**：
- 战争条款
- 外交胁迫（威慑 + 最后通牒）
- 债务控制（扩展）

---

#### 3.4 多国军事联盟（北约式 Alliance Bloc）

引入“联盟集团对象”管理多国共同防御与规则。

**联盟对象字段（概念）**：
- `members[]`
- `leader`（可选）
- `rules`: 退盟冷却、表决权、制裁、驻军许可
- `mutualDefense`: 共同防御条款
- `dues`: 会费/军费（维持联盟强度）

**共同防御触发**：
- 任一成员被宣战 → 触发联盟响应
- 成员可表决或自动参战
- 拒绝履约 → 信誉下降、联盟制裁、甚至被踢出

---

### 4. 系统交互与 UI 建议（保证玩家可理解与可控）

#### 4.1 贸易界面（派驻商人）

- 国家列表 + 每国派驻商人滑条/输入框
- 每国贸易姿态切换：`balanced/import/export/embargo`
- 右侧面板：
  - 本回合预计贸易摘要（主要商品、净利润、对国内短缺的改善）
  - 对双方市场的影响提示（价格变化箭头）

#### 4.2 市场界面（供需与价格）

- 对每个资源显示：库存、目标库存、短缺/过剩指示、当前价格
- 提供“政策按钮”（影响权重）：
  - 保供优先（提高进口短缺权重）
  - 出口创汇（提高出口利润权重）
  - 战时管制（限制出口军需）

#### 4.3 外交界面（协议中心）

- “协议中心”页签：
  - 当前生效协议列表（期限、收益、义务、违约后果）
  - 发起协议：模板化条约（开放市场、学术交流、共同防御…）
  - 联盟/附庸关系树

---

### 5. 平衡与反作弊（防止单策略碾压）

#### 5.1 防止“无限套利”

- 贸易冲击会抹平价差
- 增加运输成本/风险，远距贸易不一定稳赢
- 关税与禁运可中断套利通道

#### 5.2 防止“倾销永动机”

- 出口过多导致国内价格上涨（或国内生活成本上升，引发民怨/阶层事件）
- 关键民生品可设“最低国内保供阈值”，低于阈值禁止出口

#### 5.3 外交“背约成本”必须足够高

- 信誉下降应当在多个系统中产生惩罚（贸易条款、联盟信任、学术交流中止）

---

### 6. 分阶段实施路线（建议按风险从低到高）

#### 阶段 A：先建立供需-价格闭环（止血）

- 库存与目标库存机制完善
- 价格由库存驱动并平滑
- 贸易结算必须改变库存与价格

**验收**：供需失衡会在数回合内自我收敛（不依赖玩家手工操作）。

#### 阶段 B：派驻商人机制 + 自动撮合

- 引入 `merchantAssignments`
- 自动撮合按评分模型执行
- UI 增加派驻与摘要

**验收**：玩家只需要“派人+政策”，系统可自行完成“缺啥买啥/过剩出口”。

#### 阶段 C：Treaty 框架 + 贸易类协议 + 学术交流

- 统一协议对象
- 开放市场、关税、禁运、最惠国
- 学术交流协议与事件

**验收**：外交开始“可经营”，不再只是数值加减。

#### 阶段 D：附庸 + 多国联盟

- 附庸条款、义务与保护
- 多国共同防御联盟、违约惩罚

**验收**：出现“集团对抗/站队/威慑/背约成本”的真实地缘玩法。

---

### 7. 关键参数建议（便于落地调参）

- `merchantCapacity`: 单商人单回合最大运输量（可被科技/港口提升）
- `k_priceStock`: 库存影响价格的系数（建议小步、平滑）
- `w_shortage / w_surplus / w_price`: 评分权重
- `embargoPenalty`: 禁运/撕约对信誉的惩罚
- `treatyMaintenance`: 协议维护费（防止无脑全签）

> 建议先在开发模式下把这些参数暴露成可配置项，方便快速迭代。

---

### 8. 快速验收清单（回归测试用）

- **贸易**
  - 国内粮食低库存：自动进口粮食，且价格逐步回落。
  - 国内某工业品库存爆仓：自动出口并使库存回落。
  - 对同一国家加派商人：贸易量明显上升，并改变双方价格。

- **外交**
  - 签订开放市场：贸易效率提升或禁运解除。
  - 撕毁共同防御：信誉下降，未来签约更难/要价更高。
  - 联盟成员被攻击：触发共同防御响应与违约惩罚。
