# 逻辑斯蒂人口增长模型 (Logistic Population Growth Model)

## 📋 概述

人口增长模型基于**逻辑斯蒂增长曲线（S-curve）**。  
当前实现状态（2026-02-28）：AI 链路已接入该模型；玩家主循环仍以 `simulation.js` 中的生育/容量段逻辑为主。

## 🧭 当前接入状态（2026-02-28）

| 链路 | 当前状态 | 代码位置 |
|------|----------|----------|
| AI 人口增长 | 已接入逻辑斯蒂增长 | `src/logic/diplomacy/aiEconomy.js`, `src/logic/diplomacy/calculators/GrowthCalculator.js` |
| 玩家人口增长（主循环） | 未接入逻辑斯蒂主入口 | `src/logic/simulation.js` |
| 玩家逻辑斯蒂函数 | 已实现但未接入主循环 | `src/logic/population/logisticGrowth.js` (`calculatePlayerLogisticGrowth`) |

## 🔬 科学原理

### 旧模型的问题

**指数增长模型**（已废弃）：
```javascript
population(t+1) = population(t) × (1 + r)
```

问题：
- ❌ 无限制的指数增长
- ❌ 不考虑资源限制
- ❌ 不考虑粮食供应
- ❌ 不考虑土地面积
- ❌ 人口可以在短时间内达到不现实的数量

### 新模型：逻辑斯蒂增长

**公式**：
```
dP/dt = r × P × (1 - P/K) × ResourceFactor

其中：
- P: 当前人口
- K: 环境承载力 (Carrying Capacity)
- r: 内在增长率
- ResourceFactor: 资源约束因子
```

**特点**：
- ✅ S型增长曲线（慢→快→慢）
- ✅ 考虑资源承载力
- ✅ 人口接近上限时自动减速
- ✅ 超过承载力时负增长
- ✅ 粮食、土地、住房都会影响增长

## 📊 增长曲线对比

```
人口
  │
  │                    旧模型（指数）
  │                   ╱
  │                 ╱
  │               ╱
  │             ╱
  │           ╱
  │         ╱              新模型（逻辑斯蒂）
  │       ╱               ─────────────── K (承载力)
  │     ╱               ╱
  │   ╱               ╱
  │ ╱             ╱╱
  │╱          ╱╱
  └────────────────────────────────────> 时间
```

## 🧮 承载力计算

承载力由以下因素决定：

### 1. 粮食承载力（最关键）
```javascript
foodBasedCapacity = (foodProduction + foodStorage × 0.1) / FOOD_PER_CAPITA
```
- 每人每tick需要 0.5 粮食
- 粮食储备可以提供 10% 的缓冲

### 2. 土地承载力
```javascript
landBasedCapacity = landArea × baseDensity × densityMultiplier
```
- 基础密度：10人/单位土地
- 密度随时代和科技提升

### 3. 住房承载力（硬上限）
```javascript
housingBasedCapacity = maxPop × 1.5
```
- 允许 50% 的过度拥挤

### 4. 科技加成
```javascript
techMultiplier = agricultureBonus × medicineBonus × infrastructureBonus
```
- 农业科技：+50% 每级
- 医疗科技：+30% 每级
- 基础设施：+20% 每级

### 最终承载力
```javascript
K = min(foodCapacity, landCapacity, housingCapacity) × techMultiplier
```

## 🎯 资源因子计算

资源因子影响实际增长速度（0.2 - 2.0）：

### 1. 粮食因子（最重要）

| 粮食比例 | 因子 | 效果 |
|---------|------|------|
| ≥ 150% | 1.3 | 粮食充足，加速增长 |
| 100-150% | 1.0-1.3 | 正常增长 |
| 70-100% | 0.5-1.0 | 粮食短缺，减速 |
| < 70% | 0.2-0.5 | 严重短缺，负增长 |

### 2. 财富因子
```javascript
wealthFactor = 0.7 + (wealthPerCapita / WEALTH_BASELINE) × 0.3
```
- 范围：0.7 - 1.6

### 3. 民意因子
```javascript
approvalFactor = approval / 50
```
- 范围：0.5 - 1.5

### 4. 战争惩罚
```javascript
warFactor = isAtWar ? 0.7 : 1.0
```

## 📈 增长阶段

### 阶段 1：缓慢起步（P << K）
- 人口基数小
- 增长率：r × P（接近指数）
- 特点：人口少，增长慢

### 阶段 2：快速增长（P ≈ 0.5K）
- 逻辑斯蒂因子最大：(1 - P/K) ≈ 0.5
- 增长率最快
- 特点：S曲线的拐点

### 阶段 3：减速增长（P → K）
- 接近承载力
- 逻辑斯蒂因子 → 0
- 特点：增长逐渐停止

### 阶段 4：超载惩罚（P > K）
- 超过承载力
- 指数惩罚：exp(-(P/K - 1) × 2)
- 特点：负增长，人口下降

## 🎮 游戏中的应用

### AI国家（完整版）

**重要更新**：AI国家承载力现在**基于玩家人口的50倍**！

```javascript
calculateAILogisticGrowth({
    nation,           // AI国家对象（包含inventory）
    epoch,            // 当前时代
    difficulty,       // 游戏难度
    playerPopulation, // 玩家人口（核心参考！）
    ticksSinceLastUpdate // 距离上次更新的tick数
})
```

**核心设计**：
- AI人口上限 = 玩家人口 × 50 × 各种倍率
- 这确保AI规模与玩家同步发展，不会过于悬殊
- 难度系统可以调节这个倍数

**AI承载力计算公式**：
```javascript
// 1. 基础上限：玩家人口 × 50
playerBasedCap = max(100, playerPopulation × 50)

// 2. 发展倍率 (0.5x ~ 1.5x)
developmentModifier = 0.5 + developmentRate × 0.5

// 3. 时代倍率 (每时代+10%)
epochModifier = 1 + epoch × 0.1

// 4. 粮食倍率 (0.6x ~ 1.2x)
foodModifier = 0.6 + min(2, (foodStock + 100) / foodNeeded) × 0.3

// 5. 国力倍率 (foreignPower.populationFactor)
populationFactor = 默认 1.0

// 6. 难度承载力倍率
难度倍率:
  - 非常简单: 0.5x → AI上限 = 玩家×25
  - 简单: 0.7x → AI上限 = 玩家×35
  - 普通: 1.0x → AI上限 = 玩家×50
  - 困难: 1.3x → AI上限 = 玩家×65
  - 非常困难: 1.6x → AI上限 = 玩家×80
  - 极限: 2.0x → AI上限 = 玩家×100

// 最终承载力
K = playerBasedCap × developmentModifier × epochModifier 
    × foodModifier × populationFactor × difficultyCapMultiplier
```

**示例计算**：
```
假设：玩家人口=1000，普通难度，古典时代(epoch=2)

基础上限 = 1000 × 50 = 50,000
发展倍率 = 0.5 + 1.0 × 0.5 = 1.0
时代倍率 = 1 + 2 × 0.1 = 1.2
粮食倍率 = 1.0 (正常)
国力倍率 = 1.0 (默认)
难度倍率 = 1.0 (普通)

最终承载力 = 50,000 × 1.0 × 1.2 × 1.0 × 1.0 × 1.0 = 60,000
```

**AI资源因子**（影响增长速度，不影响上限）：
```javascript
// 1. 人均财富
if (wealthPerCapita < 20) → 0.8x (贫困)
if (wealthPerCapita > 200) → 1.2x (富裕)

// 2. 发展速率
developmentFactor = 0.9 + developmentRate × 0.1

// 3. 战争惩罚
if (isAtWar) → 0.7x

// 4. 资源多样性
if (resourceCount > 10) → 1.1x (多元经济)
```

### 玩家国家（函数已实现，主循环未接入）

```javascript
calculatePlayerLogisticGrowth({
    currentPopulation,
    resources,        // 实际资源数据
    buildings,        // 实际建筑数据
    epoch,
    bonuses,          // 科技加成
    approval,         // 民意
    isAtWar,
    difficulty
})
```

**使用实际数据**：
- 粮食产量：从resources.food读取
- 土地面积：从buildings计算
- 住房容量：从resources.maxPop读取

### 玩家接入前提与回归点

若后续把玩家主循环切换到 `calculatePlayerLogisticGrowth`，建议至少覆盖以下回归点：

1. 人口增长与失业率联动是否稳定。
2. 粮食短缺与人口惩罚是否保持原体验边界。
3. 人口政策与科技加成是否保持语义一致。
4. 各难度下中后期人口曲线是否出现突变。

## 📊 实际效果对比

### 场景 1：低粮食产量（资源受限）

| 天数 | 旧模型 | 新模型 | 承载力 |
|-----|--------|--------|--------|
| 0 | 16 | 16 | 40 |
| 20 | 26 | 24 | 40 |
| 40 | 43 | 32 | 40 |
| 60 | 70 | 37 | 40 |
| 80 | 115 | 39 | 40 |
| 100 | 189 | 40 | 40 |

**结果**：新模型在第100天稳定在承载力40，旧模型已达到189（不现实）

### 场景 2：高粮食产量（资源充足）

| 天数 | 旧模型 | 新模型 | 承载力 |
|-----|--------|--------|--------|
| 0 | 16 | 16 | 400 |
| 20 | 26 | 26 | 400 |
| 40 | 43 | 44 | 400 |
| 60 | 70 | 72 | 400 |
| 80 | 115 | 115 | 400 |
| 100 | 189 | 175 | 400 |

**结果**：资源充足时，两者增长相似，但新模型会在接近承载力时减速

### 场景 3：地狱难度对比

**旧模型**：
- 16天达到1亿人口
- 完全不考虑资源

**新模型**：
- 根据承载力动态调整
- 如果粮食不足，增长会大幅减缓
- 更加平衡和现实

## 🔧 参数调整

### 内在增长率（r）
```javascript
// AI国家
intrinsicGrowthRate = getIntrinsicGrowthRate('ai', tickScale)
effectiveRate = intrinsicGrowthRate
    * DIFFICULTY_GROWTH_MULTIPLIERS[difficulty]
    * smallNationBonus

// 玩家国家
baseGrowthRate = GROWTH_RATES.PLAYER_BASE / 10
intrinsicGrowthRate = baseGrowthRate * (1 + populationGrowthBonus)
```

### 难度倍率（AI 增长率）

| 难度 | 倍率 |
|------|------|
| veryEasy | 0.7 |
| easy | 0.85 |
| normal | 1.0 |
| hard | 1.05 |
| veryHard | 1.1 |
| impossible | 1.2 |

### 难度倍率（AI 承载力）

| 难度 | 倍率 |
|------|------|
| veryEasy | 0.5 |
| easy | 0.7 |
| normal | 1.0 |
| hard | 1.3 |
| veryHard | 1.6 |
| extreme | 2.0 |

**注意**：在 AI 链路中，难度同时影响增长率与承载力（不是只影响增长率）。

## 🎯 设计目标

1. **现实性**：人口增长符合真实世界规律
2. **平衡性**：资源管理变得重要
3. **策略性**：玩家需要平衡粮食、土地、住房
4. **可预测性**：增长曲线平滑，不会突然爆炸
5. **挑战性**：高难度下AI仍有优势，但不会离谱

## 📝 使用示例

### 测试对比

```javascript
import { demonstrateScenarios } from './logic/population/growthComparison';

// 运行对比测试
demonstrateScenarios();
```

这将输出三个场景的详细对比：
1. 低粮食产量（资源受限）
2. 高粮食产量（资源充足）
3. 中等资源（平衡）

## 🚀 未来改进

1. **动态承载力**：随着科技发展动态提升
2. **区域差异**：不同地形的承载力不同
3. **疾病系统**：高密度人口的疾病风险
4. **移民系统**：人口在国家间流动
5. **年龄结构**：考虑人口年龄分布

## 📚 参考资料

- [Logistic Function - Wikipedia](https://en.wikipedia.org/wiki/Logistic_function)
- [Carrying Capacity - Wikipedia](https://en.wikipedia.org/wiki/Carrying_capacity)
- Verhulst, P. F. (1838). "Notice sur la loi que la population suit dans son accroissement"

---

**版本**: 1.0.0  
**作者**: AI Assistant  
**日期**: 2026-01-29  
**状态**: ✅ AI国家已完成，⏳ 玩家国家待集成  
**Last verified against commit**: `9015497` (2026-02-28)
